<!DOCTYPE html>
<html>
<head>
    #set($pageTitle = $i18n.get("title.config.management"))
    #parse("blocks/html-head.vm")
</head>
<body class="hold-transition sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">
    #parse("blocks/navbar.vm")

    #set($currentPage = "config")
    #parse("blocks/sidebar.vm")

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>$i18n.get("title.config.management")</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">$i18n.get("page.home")</a></li>
                            <li class="breadcrumb-item active">$i18n.get("title.config.management")</li>
                        </ol>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <!-- Config推送调试面板 -->
            <div class="row">
                <div class="col-12">
                    <div id="config-debug-panel" class="card card-warning collapsed-card" style="display:none;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fa fa-bug"></i> Config推送调试面板
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-warning btn-sm" data-card-widget="collapse">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button type="button" class="btn btn-warning btn-sm" onclick="clearDebugLog()">
                                    <i class="fa fa-trash"></i> 清空
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>📋 推送参数</h5>
                                    <div id="push-params-display" class="debug-content">
                                        <p class="text-muted">点击推送按钮时显示参数</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>📋 模块匹配结果</h5>
                                    <div id="module-match-display" class="debug-content">
                                        <p class="text-muted">显示匹配的模块列表</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <h5>📝 调试日志</h5>
                                    <div id="debug-log-display" class="debug-log">
                                        <!-- 实时调试日志 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card card-blue card-outline">
                        <div class="card-header border-0">
                            <h5 class="card-title text-blue">
                                $i18n.get("title.config.management") <i class="fa fa-cogs"></i>
                            </h5>
                            <div class="card-tools">
                                <div class="btn-group float-right" role="group" style="margin-right: 10px;">
                                    <button type="button" class="btn btn-info btn-sm" onclick="openEnvironmentChecker()">
                                        <i class="fa fa-check-circle"></i> Environment检查器
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" onclick="toggleConfigDebugPanel()">
                                        <i class="fa fa-bug"></i> 调试面板
                                    </button>
                                </div>
                                <a href="/config/add.htm" target="_blank" class="btn btn-primary btn-sm float-right"
                                        data-loading-text="searching">
                                    $i18n.get("button.add.config")
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-12">
                                    <form class="form-inline" method="get" action="list.htm">
                                        <div class="form-group" style="margin-left:10px">
                                            <label for="appName">$i18n.get("label.app.name"):</label>
                                            <input type="text" class="form-control" placeholder="$i18n.get('label.app.name')" 
                                                   name="appName" value="$!requestParams.appName" autocomplete="off"
                                                   data-toggle="tooltip" title="$i18n.get('label.app.name')" 
                                                   style="width: 210px;margin-left:10px">
                                        </div>
                                        <div class="form-group" style="margin-left: 10px">
                                            <label for="environment">$i18n.get("label.environment"):</label>
                                            <input type="text" class="form-control" placeholder="$i18n.get('label.environment')" 
                                                   name="environment" value="$!requestParams.environment" autocomplete="off"
                                                   data-toggle="tooltip" title="$i18n.get('label.environment')" 
                                                   style="width: 210px;margin-left:10px">
                                        </div>
                                        <div class="form-group" style="margin-left: 20px">
                                            <button type="submit" class="btn btn-primary"
                                                    data-loading-text="searching" id="search-online-btn">
                                                $i18n.get("button.query") <i class="fa fa-search icon-on-right bigger"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <table class="table table-hover table-striped" style="word-break: break-all;">
                                #if($pagerWrapper.content && $pagerWrapper.content.size() > 0)
                                    <thead>
                                    <tr>
                                        <th>$i18n.get("table.app.name")</th>
                                        <th>$i18n.get("table.environment")</th>
                                        <th>$i18n.get("form.config.model")</th>
                                        <th>$i18n.get("table.create.time")</th>
                                        <th>$i18n.get("table.modify.time")</th>
                                        <th width="150px">$i18n.get("table.operation")</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($data in $pagerWrapper.content)
                                        <tr>
                                            <td style="vertical-align: middle">$!data.appName</td>
                                            <td style="vertical-align: middle">$!{data.environment}</td>
                                            <td style="vertical-align: middle">$!data.configModel</td>
                                            <td style="vertical-align: middle">$!{data.gmtCreate}</td>
                                            <td style="vertical-align: middle">$!{data.gmtModified}</td>
                                            <td style="vertical-align: middle">
                                                <a href="/config/detail.htm?appName=$!{data.appName}&environment=$!{data.environment}" 
                                                   class="btn btn-primary btn-xs" data-toggle="tooltip"
                                                   title="$i18n.get('button.detail')" data-env="$!{data.environment}"
                                                   data-app="$!{data.appName}">$i18n.get("button.detail")
                                                </a>
                                                <a href="/config/edit.htm?appName=$!{data.appName}&environment=$!{data.environment}" 
                                                   class="btn btn-info btn-xs" data-toggle="tooltip"
                                                   title="$i18n.get('button.edit')" data-env="$!{data.environment}"
                                                   data-app="$!{data.appName}">$i18n.get("button.edit")
                                                </a>
                                                <button class="btn btn-success btn-xs btn-push" data-toggle="tooltip"
                                                        title="$i18n.get('button.push')" data-env="$!{data.environment}"
                                                        data-app="$!{data.appName}">$i18n.get("button.push")
                                                </button>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                #else
                                    <h5 style="padding-left: 10px;margin-top: 20px">$i18n.get("msg.no.config")</h5>
                                #end
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    #parse("blocks/footer.vm")
</div>
<!-- ./wrapper -->

#parse("blocks/header-scripts.vm")
#parse("blocks/fakeloader.vm")

<script type="application/javascript">
    jQuery(function ($) {
        $(".btn-push").on('click', function () {
            var appName = $(this).attr('data-app');
            var environment = $(this).attr('data-env');
            
            // 显示调试面板并记录推送参数
            showConfigDebugPanel();
            logPushParams(appName, environment);
            
            // 先查询匹配的模块
            checkModuleMatches(appName, environment, function(matchResult) {
                logModuleMatches(matchResult);
                
                if (matchResult.hasMatches) {
                    // 有匹配的模块，执行推送
                    executePushConfig(appName, environment);
                } else {
                    // 没有匹配的模块，显示详细原因
                    showNoMatchReason(matchResult.reason, matchResult.suggestions);
                }
            });
        })
        
        // ==================== 方案1：Config推送调试面板函数 ====================
        
        window.toggleConfigDebugPanel = function() {
            var $panel = $('#config-debug-panel');
            if ($panel.is(':visible')) {
                $panel.hide();
            } else {
                $panel.show();
                if ($panel.hasClass('collapsed-card')) {
                    $panel.find('[data-card-widget="collapse"]').click();
                }
            }
        };
        
        function showConfigDebugPanel() {
            $('#config-debug-panel').show();
            if ($('#config-debug-panel').hasClass('collapsed-card')) {
                $('#config-debug-panel').find('[data-card-widget="collapse"]').click();
            }
        }
        
        function logPushParams(appName, environment) {
            var params = {
                appName: appName,
                environment: environment,
                timestamp: new Date().toLocaleString()
            };
            
            var html = '<div class="param-item">' +
                '<strong>应用名:</strong> <span class="text-primary">' + appName + '</span><br>' +
                '<strong>环境:</strong> <span class="text-info">' + environment + '</span><br>' +
                '<strong>时间:</strong> <span class="text-muted">' + params.timestamp + '</span>' +
                '</div>';
            
            $('#push-params-display').html(html);
            addDebugLog('[PUSH]', '开始推送Config - AppName: ' + appName + ', Environment: ' + environment);
        }
        
        function checkModuleMatches(appName, environment, callback) {
            addDebugLog('[QUERY]', '正在查询匹配的模块...');
            
            $.ajax({
                url: '/config/checkMatches.json',
                method: 'GET',
                data: { appName: appName, environment: environment },
                success: function(response) {
                    if (response.success) {
                        callback(response.data);
                    } else {
                        callback({
                            hasMatches: false,
                            reason: 'api_error',
                            suggestions: [response.message],
                            matchCount: 0,
                            availableEnvironments: []
                        });
                    }
                },
                error: function() {
                    callback({
                        hasMatches: false,
                        reason: 'network_error',
                        suggestions: ['检查网络连接', '重试操作'],
                        matchCount: 0,
                        availableEnvironments: []
                    });
                }
            });
        }
        
        function logModuleMatches(matchResult) {
            var html = '';
            if (matchResult.hasMatches) {
                html = '<div class="alert alert-success">' +
                    '<strong>[OK] 找到 ' + matchResult.matchCount + ' 个匹配的模块</strong>' +
                    '</div>' +
                    '<div class="mt-2">' +
                    '<small class="text-muted">匹配的模块将接收Config推送</small>' +
                    '</div>';
                addDebugLog('[OK]', '找到 ' + matchResult.matchCount + ' 个匹配的模块');
            } else {
                var envBadges = '';
                for (var i = 0; i < matchResult.availableEnvironments.length; i++) {
                    envBadges += '<span class="badge badge-secondary mr-1">' + matchResult.availableEnvironments[i] + '</span>';
                }
                
                html = '<div class="alert alert-danger">' +
                    '<strong>[ERROR] 没有找到匹配的模块</strong>' +
                    '</div>' +
                    '<div class="mt-2">' +
                    '<strong>原因:</strong> <span class="text-danger">' + getReasonText(matchResult.reason) + '</span><br>' +
                    '<strong>可用的Environments:</strong><br>' +
                    envBadges +
                    '</div>';
                addDebugLog('[ERROR]', '没有找到匹配的模块 - ' + getReasonText(matchResult.reason));
            }
            
            $('#module-match-display').html(html);
        }
        
        function getReasonText(reason) {
            switch(reason) {
                case 'no_modules': return '该应用没有注册任何模块';
                case 'environment_mismatch': return 'Environment不匹配';
                case 'api_error': return 'API调用错误';
                case 'network_error': return '网络连接错误';
                default: return '未知原因';
            }
        }
        
        function executePushConfig(appName, environment) {
            addDebugLog('🚀', '开始执行Config推送...');
            showLoading(10);
            
            $.ajax({
                type: 'POST',
                url: "//" + host + "/config/push.json",
                data: {
                    "appName": appName,
                    "environment": environment,
                },
                success: function (res) {
                    hideLoading(10);
                    if (res.success) {
                        addDebugLog('[SUCCESS]', 'Config推送成功: ' + res.message);
                    } else {
                        addDebugLog('[FAIL]', 'Config推送失败: ' + res.message);
                    }
                    notice(res.message, res.success);
                },
                dataType: 'json',
                error: function (XMLHttpRequest) {
                    hideLoading(10);
                    addDebugLog('[EXCEPTION]', 'Config推送异常: ' + XMLHttpRequest.responseText);
                    notice(JSON.stringify(XMLHttpRequest), false);
                }
            });
        }
        
        function showNoMatchReason(reason, suggestions) {
            var suggestionHtml = '';
            for (var i = 0; i < suggestions.length; i++) {
                suggestionHtml += '<li>' + suggestions[i] + '</li>';
            }
            
            var alertHtml = '<div class="alert alert-warning">' +
                '<h5><i class="fa fa-exclamation-triangle"></i> 无法推送Config</h5>' +
                '<p><strong>原因:</strong> ' + getReasonText(reason) + '</p>' +
                '<p><strong>建议:</strong></p>' +
                '<ul>' + suggestionHtml + '</ul>' +
                '</div>';
            
            $("#danger-message-area").html(alertHtml);
            $("#danger-modal").modal('show');
        }
        
        function addDebugLog(icon, message) {
            var timestamp = new Date().toLocaleTimeString();
            var logEntry = '<div class="debug-log-entry">' +
                '<span class="text-muted">[' + timestamp + ']</span> ' +
                '<span>' + icon + '</span> ' +
                '<span>' + message + '</span>' +
                '</div>';
            
            var $logDisplay = $('#debug-log-display');
            $logDisplay.append(logEntry);
            $logDisplay.scrollTop($logDisplay[0].scrollHeight);
        }
        
        window.clearDebugLog = function() {
            $('#debug-log-display').empty();
            $('#push-params-display').html('<p class="text-muted">点击推送按钮时显示参数</p>');
            $('#module-match-display').html('<p class="text-muted">显示匹配的模块列表</p>');
        };
        
    })
</script>

<!-- 方案2：Environment检查器JavaScript -->
<script type="application/javascript">
    // ==================== 方案2：Environment一致性检查器函数 ====================
    
    window.openEnvironmentChecker = function() {
        if (!$('#environment-checker-modal').length) {
            createEnvironmentCheckerModal();
        }
        $('#environment-checker-modal').modal('show');
        runEnvironmentCheck();
    };
    
    function createEnvironmentCheckerModal() {
        var modalHtml = '<div class="modal fade" id="environment-checker-modal" tabindex="-1">' +
            '<div class="modal-dialog modal-lg">' +
            '<div class="modal-content">' +
            '<div class="modal-header bg-info">' +
            '<h4 class="modal-title">' +
            '<i class="fa fa-check-circle"></i> Environment一致性检查器' +
            '</h4>' +
            '<button type="button" class="close" data-dismiss="modal">' +
            '<span>×</span>' +
            '</button>' +
            '</div>' +
            '<div class="modal-body">' +
            '<div id="environment-check-content">' +
            '<!-- 检查结果内容 -->' +
            '</div>' +
            '</div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-primary" onclick="runEnvironmentCheck()">' +
            '<i class="fa fa-refresh"></i> 重新检查' +
            '</button>' +
            '<button type="button" class="btn btn-success" onclick="autoFixEnvironments()" id="auto-fix-btn" style="display:none;">' +
            '<i class="fa fa-magic"></i> 自动修复' +
            '</button>' +
            '<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
        $('body').append(modalHtml);
    }
    
    function runEnvironmentCheck() {
        var $content = $('#environment-check-content');
        $content.html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> 正在检查...</div>');
        
        $.ajax({
            url: '/config/checkEnvironments.json',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displayEnvironmentCheckResult(response.data);
                } else {
                    $content.html('<div class="alert alert-danger">检查失败: ' + response.message + '</div>');
                }
            },
            error: function() {
                $content.html('<div class="alert alert-danger">检查失败，请重试</div>');
            }
        });
    }
    
    function displayEnvironmentCheckResult(data) {
        var html = '';
        
        // 总体状态
        if (data.hasIssues) {
            html += '<div class="alert alert-warning">' +
                '<h5><i class="fa fa-exclamation-triangle"></i> 发现Environment不匹配问题</h5>' +
                '<p>发现 ' + data.issueCount + ' 个不匹配的Config配置</p>' +
                '</div>';
            $('#auto-fix-btn').show();
        } else {
            html += '<div class="alert alert-success">' +
                '<h5><i class="fa fa-check"></i> Environment配置正常</h5>' +
                '<p>所有Config的Environment都有对应的模块</p>' +
                '</div>';
            $('#auto-fix-btn').hide();
        }
        
        // 详细的匹配表
        if (data.details &amp;&amp; data.details.length > 0) {
            html += '<h5>📋 详细匹配情况</h5>';
            html += '<table class="table table-sm table-striped">' +
                '<thead>' +
                '<tr>' +
                '<th>Config (AppName)</th>' +
                '<th>Config Environment</th>' +
                '<th>匹配状态</th>' +
                '<th>可用的Module Environments</th>' +
                '<th>建议</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';
            
            data.details.forEach(function(item) {
                var statusClass = item.matched ? 'text-success' : 'text-danger';
                var statusIcon = item.matched ? 'fa-check' : 'fa-times';
                var statusText = item.matched ? '匹配' : '不匹配';
                
                var envBadges = '';
                for (var i = 0; i < item.availableEnvironments.length; i++) {
                    envBadges += '<span class="badge badge-secondary">' + item.availableEnvironments[i] + '</span> ';
                }
                
                html += '<tr>' +
                    '<td>' + item.configAppName + '</td>' +
                    '<td><span class="badge badge-primary">' + item.configEnvironment + '</span></td>' +
                    '<td class="' + statusClass + '">' +
                    '<i class="fa ' + statusIcon + '"></i> ' + statusText +
                    '</td>' +
                    '<td>' + envBadges + '</td>' +
                    '<td>' + item.suggestion + '</td>' +
                    '</tr>';
            });
            
            html += '</tbody></table>';
        }
        
        $('#environment-check-content').html(html);
    }
    
    window.autoFixEnvironments = function() {
        if (confirm('确定要自动修复Environment不匹配的问题吗？这将修改Config表中的environment字段。')) {
            $.ajax({
                url: '/config/autoFixEnvironments.json',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        notice('自动修复完成: ' + response.message, true);
                        runEnvironmentCheck(); // 重新检查
                    } else {
                        notice('自动修复失败: ' + response.message, false);
                    }
                },
                error: function() {
                    notice('自动修复请求失败', false);
                }
            });
        }
    };
</script>

<!-- 调试面板样式 -->
<style>
    .debug-content {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        min-height: 100px;
    }
    
    .debug-log {
        background: #1e1e1e;
        color: #f8f9fa;
        border-radius: 4px;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    
    .debug-log-entry {
        margin-bottom: 5px;
        padding: 2px 5px;
        border-radius: 2px;
        line-height: 1.4;
    }
    
    .param-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 3px;
        padding: 8px;
    }
</style>

</body>
</html>